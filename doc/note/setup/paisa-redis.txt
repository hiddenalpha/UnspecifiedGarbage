
Redis Servers for PaISA
=======================

Install a base system. While creating this script, I used
"devuan_daedalus_5.0.1_amd64_netinstall.iso" (md5:0c41745574898e210d80a4ada330bbd8).


## Install at target machine

  && http_proxy= \
  && https_proxy="${http_proxy?}" \
  && no_proxy= \
  && REDIS_HOUSTON_PW= \
  && REDIS_EAGLE_PW="${REDIS_HOUSTON_PW?}" \
  && WITH_REDIS_CLIENT=0 \
  && SUDO=sudo \
  \
  && if test "$(whoami)" != "user" ;then echo "ERROR: Unexpected user: $(whoami)"; false ;fi true \
  && if test -n "${http_proxy:?}" ;then true \
      && printf %s\\n \
          'Acquire::http::proxy "'"${http_proxy:?}"'";' \
          'Acquire::https::proxy "'"${https_proxy:?}"'";' \
          | $SUDO tee /etc/apt/apt.conf.d/80proxy >/dev/null \
      && printf %s\\n \
          "http_proxy=${http_proxy:?}" \
          "https_proxy=${https_proxy:?}" \
          "HTTP_PROXY=${http_proxy:?}" \
          "HTTPS_PROXY=${http_proxy:?}" \
          "no_proxy=${no_proxy:?}" \
          "NO_PROXY=${no_proxy:?}" \
          | $SUDO tee /etc/environment >/dev/null \
    ;fi \
  && $SUDO apt update \
  && $SUDO RUNLEVEL=1 apt install --no-install-recommends -y redis-server \
        $(test "${WITH_REDIS_CLIENT:?}" -ne 0 && echo redis-tools || true) \
  && `# Add some swap (bcause 2 redis potentially need a LOT of memory) ` \
  && SWAP_MIB=$((12*1024)) \
  && $SUDO dd if=/dev/zero of=/swapfile1 bs=$((1024*1024)) count="${SWAP_MIB:?}" \
  && $SUDO chmod 0600 /swapfile1 \
  && $SUDO mkswap /swapfile1 \
  && printf '/swapfile1  none  swap  sw,pri=10  0  0\n' | $SUDO tee > /dev/null -a /etc/fstab \
  && `# Disable the default redis-server ` \
  && $SUDO service redis-server stop \
  && $SUDO update-rc.d redis-server remove \
  && $SUDO rm /etc/init.d/redis-server \
  && `# Create config files ` \
  && <<EOF base64 -d|gzip -d|$SUDO tee /etc/redis/redis-houston.conf >/dev/null &&
H4sIANI0O2cAA31UTW/bMAy961cI7llJnDZBdxywAe1lLdYNOxayRMdC9TVJdpYU/e8j7TRrGqw2
YPjx8UN8pH3B2QVPoE0WGdIAiavgW7PhUstYQPM2JH4vbx8+85vQ5xL8DANYY7zmi9l4sxhS4evL
608splBAYZhwQQP3gRUVRSPVkw0bvqprVoyD0Be+GJkngCitGQCxluCCN3vgO8gsGt0aC3yeej8f
zzfvpvoTEgc0Q0eGyS0MYLFgMQoIT8GDTHMEhwSngWjHmkU2MkPm9ZpJu5U7lKELW4FkoONnKAKb
UqKYYg8nO0JRwEUrC/DqeTS88GdrcgEvpNYJ0STpKMZLxbBsFNtkCmQRvGg2WQ4gICWUmDIn3ajg
YoKcTfBHUwfqKfduxBTBq4rphhr00gHXvYsz9CNfocGKvPNKEJ2pA23SQQfTnArJZIzgdfB2N+ae
4DFv9Y+eydBWBx7zvafR9Mq2VJzK+iDeWKjdBGPrRMq+IB3aV5uIkBT4IjfA68U57YwXmTajXiyv
XMOyDVucEE1J0DtKXDrpkcbryDr5R2AvvF5eM1qMdof7tstRKhR9wHKZlKQJk6dBjK9oTgaVW9VL
JlXB1UzQydwZvxlFUtagi8AVjn0RTd+2WNwaZwo2lpy0fEH3R37Z0hCXq7Vr+PqKHh+6x77JfcMv
l+h5PXl3+1GmNwoZrxI4ktCKaQbj9sDv3iT8xHLm379+uX14vLn7+fDj7tvj/S9meynoazyUWZF0
1Omoxt5E2uQTOc7IQdoesAU2ov+FnZHHsP2r9u/DaGJn5DEsd33RYetpqbLZ4OB45cOW/lQKqvd0
geRO+L9r5Go58gQAAA==
EOF
true \
  && <<EOF base64 -d|gzip -d|$SUDO tee /etc/redis/redis-eagle.conf >/dev/null &&
H4sIAO00O2cAA31TTW8aMRC9+1dY5GxgSaDpMVJRFamHqDn0GM2uZ8GKv2p7oRDlv3fGEEKDml1p
5Zk3H35vZq+kuJIJtckqY9pgkl3wvVlJ0BALatmHJB/g/vFOLmFlcUzhojVey+m4viKGVOTi+stX
EVMo2FGSckGj9EGULqoWumcbVnLeNKIYh2EoclqRZ8QI1myQbA3ogjd7lDvMIhrdG4tykgY/qbeb
IHc/nFU9jylIUGGLG7TUrJgO2T4kbiBNyDgmn6eRl7oVaCFjls1CgN3Cjuivw1YRGPjiGYsiOp0q
ptjjnU6mKuiihYJy9FIdr/LFmlzQK9A6kXWQssrwOhK5hKi2yRTMKnjVrjJsUGFKJC1XZlOORiLp
tgsuJszZBF8hdq2xe86Dq7ZumZ4Hh1IPLo4J5xil0aq8851iODMDbdJRBdOeSyggRvQ6eLurFQ/m
qeroHR5D6EdHnKp9hMn1hvbcmpv6oM48TDZhJc4gDIXg0L/5VMTUoS+wQtlML2FnvMq8Ec10duNa
kW3Y0nx4RorPJHBZgyeYnhPq4I8iLrKZ3Qpein5He7bLETqSfEPtMkvN8+VIQzYdyZ0M6TZvZgK6
QiuZcA15bfyqitRZQyGKVjcORbVD31Nza5wpRCw5sHLK72dx2fKUZ/OFa+Xihj+fhsehzUMrr2cU
eXuIXu+rTGcKGd8ldCyhVYcZ1J3B34NJ9GvlLH8uv90/Pi3vvv9YPj38EnYAxf/gscmchWOeVYu9
ibzF/4hxAW7ADkgERLX+l3YBntL2b8p/TON5XYCntL9R+X97pwQAAA==
EOF
true \
  && `# Configure logging ` \
  && <<EOF base64 -d|gzip -d|$SUDO tee /etc/logrotate.d/redis-houston >/dev/null &&
H4sIAMo2M2cAA0WMSwqAMBBD956ia0G78ULFjrX0M6UzKkW8u4IyZhHIS4jeTdURna5gPb0+rLgR
Y+7Hp1Bnpz4dACE2ickT+ewwCKnIhkFNAmZMpQKRgIzsF0iF/xsL0TQZXt0NK02chpIAAAA=
EOF
true \
  && <<EOF base64 -d|gzip -d|$SUDO tee /etc/logrotate.d/redis-eagle >/dev/null &&
H4sIAOo2M2cAA0XMwQqAIBAE0Ltf4TkoL/2Q5CSSuuJKIdG/FxTbHgbmMazZbTWRvKlwgd8cYX3E
MD2sT6W/O4AtdqkpMIfsaROp1GyDngUWSqWCWSBTCytSaf8bh2i7DC91A0WammaQAAAA
EOF
true \
  && `# Register as new services ` \
  && <<EOF_uQAAAOgdAABpQAAA base64 -d|gzip -d|$SUDO tee /etc/init.d/redis-houston >/dev/null &&
H4sIAJgxM2cAA5VTXW/aMBR9jn/FbYimdZIb6NZVomISHbSNVCgC+jRNKCROsRrizHa6VoX/vmsn
ZKRim/aS2L5f55x7b+sI/CXPfLUirVYLLofXwRiCcTDHz9UdacFEiiceM9V1HMliruhKFEqLDE1T
9qPg+EhnOpS663jqRaXiATzJ1kKzRaKaTiL/g88Mc6Z1GsdLRRSmb0wmuGEZsCQsUr2LOoWP8AnO
GgYb04YOfC4zSU0HTEWS55qLrNskBBSx4h0Gl5AICZMwmPXhpmbbiKxCFZNPTP4jEmUdjgd7ohIy
6c9ven6hpG8J+Qpb0N2722v5WFt+++CBDPrD0d24t7v7+3gq46I/vZ71fKaj0uo36J5EIkvIuD8a
9pp9HQxnX988ken9eBBMe74sqkr+zjQJBlfB7bDnlS5vauQ8JkQzpYE+g1fCgs0G2DPX0CaEJ/AN
qAQLMi775nsGFHwnesUy4pwcMJKEE4KGlC/9VC19nnFNkyKLTHMUIYphQVald733PAZaHLtw1AO3
7dapcQ4XScjTQrLFWj2AO0LUsGSANCFUIIXQJy5xLNqOLRqFimHGjgvYAwBlZu8YPaKVAJqBa4eR
ZzjfRsYuYPT6MeY4IjlUEhFHiyJagVdJRxwM/pmBVa5rvzvXhs9axHB+dlanIU6pHlb17m+DUTA3
zJySmlOkfI2o0VoZjexaFow4hoeJteAp9imncYjbiBtA7Rv+cWeNhlQ8ZiJGarRYh+oR2u1zPGNX
E56yGh0+RasCRd6nQCl7ZlHddEp3RzuWNU6rnGu7aqVOFatfTW9Y7FrEzsWF1VvkTblFnjfk/gsz
keNPMi1fzJYyXBR/PpyO/M4hvgc47vP5f/xyDTTZa6hKGctxqgwxZCaZBb1BZBFDlKkIY2Tqvba3
lnV9RKddDF50odCrPCxEssiliOysvVaFtngsIZuTgbndhX/YKeneq/CBdctFM7t0EldL+FqCMgA2
hxBuyspbF768O60XxeRnKowIqfb8F5G7/VplBgAA
EOF_uQAAAOgdAABpQAAA
true \
  && <<EOF_FgsAAD8WAACUVQAA base64 -d|gzip -d|$SUDO tee /etc/init.d/redis-eagle >/dev/null &&
H4sIAAAAAAAAA5VTbW/TMBD+HP+KI40QIHlpgTGpqEgdLRBpLVPbfUKoypLLai2Ng+3ApnX/nbOT
hgYVBF+Ss+/Fz/PcXe8JhNeiCPWG9Xo9OJ9+jOYQzaMVfT58Zj24VPK7SFEPPU9hKjTH+CZHcizw
WyXoii9NrMzQC/S9zuUNBAq30uA6090gWf4hZrmRVd6W8YJcJnH+m8smdzwTzOIqN/usl/AKXsNp
x+Fy+jCAN3UlZfgEdaJEaYQshod0gBNSOsHkHDKp4DKOlmOYNkw7Wf+cRmpO55MDLRm7HK8+jcJK
q9AxCTUpPzw4u2N92Xp+xZDBJuPp7PN8tD+HNRiN6juqxrkeLz4uRyGapPaGB4BPEllkbD6eTUeH
zZxMl+87F2xxNZ9Ei1GoquaNsHZcRpMP0cV0FNQBndqlSBkzqA3wOwhqMLDbAd4JA33GRAZfgCtw
0NK6TWFgwcBXZjZYMO/kiJNlgjFy5OI6zPV1KApheFYVie2HZkwjPYhNeT94JlLg1XMfnozA7/tt
aRq7dRaLvFK43uob8GcVIb1GIIoQa1BSmhOfeQ7twD2axBqp4sAHUh5A21F7ThHJRgIvwHezJwoa
ZyvgECh7e5sKBbyERiDmGVklGwga4ZhHyT8KcLoN3Xcf2onZyhTOTk/bMsyr1aNXg6uLaBatLDOv
puZVudgSavI2Tiu7URUyz/KwuQ4817QUPI1p+Qrg3N3Rn1bUasjlbSFTosarbaxvod8/I5u6mgka
9T06uko2FYl8SIFzvMOkbTrne9MNY4vTKee7rjqpc43tre0Npr5D7L196/SWZVduWZYduf/CTJb0
U2jUvd1MpPUIV9PFLBwc43uE4yGf/8evtsCzg4bqHLGkqbLEiJlCB3pHyBIklLmMU2IaPPQfHevW
pKB9Dh1MpSmqNtYyW5dKJm7WHpqHHsmsIVvLwnzcp7/YK+lf6fgGh/Wi2V06SZslfKhBWQC7Ywh3
9cuPPrx7+rJdFFsfdZww1uz5T5ei0QZSBgAA
EOF_FgsAAD8WAACUVQAA
true \
  && `# Tune file permissions, inject some variables into config files ` \
  && $SUDO chmod 755 /etc/init.d/redis-houston /etc/init.d/redis-eagle \
  && $SUDO mkdir /var/lib/redis/houston /var/lib/redis/eagle \
  && $SUDO chown redis:redis /var/lib/redis/houston /var/lib/redis/eagle \
  && $SUDO sed -i -E 's,REDIS_HOUSTON_PW,'"${REDIS_HOUSTON_PW?}"',g' /etc/redis/redis-houston.conf \
  && $SUDO sed -i -E 's,REDIS_EAGLE_PW,'"${REDIS_EAGLE_PW?}"',g' /etc/redis/redis-eagle.conf \
  && `# Enable the two new redis servers ` \
  && $SUDO update-rc.d redis-houston defaults \
  && $SUDO update-rc.d redis-eagle defaults \
  && `# Add 'user' to 'adm' group to allow access to logs ` \
  && $SUDO sed -i -E 's/^(adm:x:[^:]*:.+)$/\1'",$USER"'/' /etc/group \
  && $SUDO sed -i -E 's,^(adm:x:[^:]*:)$,\1'"$USER"',' /etc/group \
  && `# Cleanup for smaller VM images ` \
  && $SUDO apt clean \
  && printf 'DONE :)\n' \



## PostInstall at VM host

  && VM= \
  && NOW=$(date -u +%Y%m%d-%H%M%S) \
  && DSTTAR="qemu-paisa-redis-${NOW:?}.tar" \
  && DSTTXZ="${DSTTAR%.*}.txz" \
  && DSTMD5="${DSTTAR%.*}.md5" \
  && HDA=hda.qcow2 \
  && TMP1=sparsed.qcow2 \
  && TMP2=snap.qcow2 \
  && ssh "${VM:?}" 'sudo rm /tmp/* /root/.bash_history .bash_history' \
  && ssh "${VM:?}" 'sudo poweroff && while true;do sleep 1;done' \
  && sleep 10 \
  && qemu-img convert -O qcow2 -S 1M "${HDA:?}" "${TMP1:?}" \
  && mv "${HDA:?}" "${TMP2:?}" \
  && mv "${TMP1:?}" "${HDA:?}" \
  && tar --owner=0 --group=0 -cf "${DSTTAR:?}" README "${HDA:?}" MD5SUM \
  && md5sum -b "${DSTTAR:?}" >> "${DSTMD5:?}" \
  && < "${DSTTAR:?}" xz -vv --lzma2=preset=9,nice=273,dict=1G > "${DSTTXZ:?}" \
  && md5sum -b "${DSTTXZ:?}" >> "${DSTMD5:?}" \


