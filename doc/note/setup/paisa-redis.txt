
Redis Servers for PaISA
=======================

Install a base system. While creating this script, I used
"devuan_daedalus_5.0.1_amd64_netinstall.iso" (md5:0c41745574898e210d80a4ada330bbd8).


## Install at target machine

  && http_proxy= \
  && https_proxy="${http_proxy?}" \
  && no_proxy= \
  && REDIS_HOUSTON_PW= \
  && REDIS_EAGLE_PW="${REDIS_HOUSTON_PW?}" \
  && WITH_REDIS_CLIENT=0 \
  && SUDO=sudo \
  \
  && if test "$(whoami)" != "user" ;then echo "ERROR: Unexpected user: $(whoami)"; false ;fi true \
  && if test -n "${http_proxy:?}" ;then true \
      && printf %s\\n \
          'Acquire::http::proxy "'"${http_proxy:?}"'";' \
          'Acquire::https::proxy "'"${https_proxy:?}"'";' \
          | $SUDO tee /etc/apt/apt.conf.d/80proxy >/dev/null \
      && printf %s\\n \
          "http_proxy=${http_proxy:?}" \
          "https_proxy=${https_proxy:?}" \
          "HTTP_PROXY=${http_proxy:?}" \
          "HTTPS_PROXY=${http_proxy:?}" \
          "no_proxy=${no_proxy:?}" \
          "NO_PROXY=${no_proxy:?}" \
          | $SUDO tee /etc/environment >/dev/null \
    ;fi \
  && $SUDO apt update \
  && $SUDO RUNLEVEL=1 apt install --no-install-recommends -y redis-server \
        $(test "${WITH_REDIS_CLIENT:?}" -ne 0 && echo redis-tools || true) \
  && `# Add some swap (bcause 2 redis potentially need a LOT of memory) ` \
  && SWAP_MIB=$((12*1024)) \
  && $SUDO dd if=/dev/zero of=/swapfile1 bs=$((1024*1024)) count="${SWAP_MIB:?}" \
  && $SUDO chmod 0600 /swapfile1 \
  && $SUDO mkswap /swapfile1 \
  && printf '/swapfile1  none  swap  sw,pri=10  0  0\n' | $SUDO tee > /dev/null -a /etc/fstab \
  && `# Disable the default redis-server ` \
  && $SUDO service redis-server stop \
  && $SUDO update-rc.d redis-server remove \
  && $SUDO rm /etc/init.d/redis-server \
  && `# Create config files ` \
  && <<EOF base64 -d|gzip -d|$SUDO tee /etc/redis/redis-houston.conf >/dev/null &&
H4sIAGgxM2cAA31Ty27bMBC88ysI50zbcmojPRZogeTSBE2LHosVubKI8FWSsisH+fcuKcdNYjQW
YGh29jm7uuDsgkdUOomEcYeRS+86veWgIGRUvPOR38HN/Sd+7YeUvZtTAGu1U3w5rw8LPma+ubz6
yEL0GSWFCesVcudZlkG0IB+M3/J107CsLfoh82VlHhADGL1DwgrQeqcPyEdMLGjVaYN8EQe3qP0t
+qn+hMQRzcmRUXKDOzRUMGuJBU/BO4gLAscErwPJTjUztJAw8WbDwOxhJBl6vxdE+tJ+wixoKCmy
zubY2QmKjDYYyMhnj9XwxB+NThmdAKUioUnSKsbTjFHZIPZRZ0zCO9FuE+xQYIwkcckcVSu9DRFT
0t6dTD3KhzTYilVbBnNgkavBhjnxxUcoNCKNTopCp9K50vE4v25fC8ggBHTKOzPWnBM85Z39o+fg
u9mRp3xvaTI9s10pzmkHcUwomfPihb0MG7EOXjqDIRPtu2ebCBglugxb5M3ynLbaiVTuotnYliXj
97SdsiFR3kne3IOjSPqdWAt/BM3Dm9UVK0fRjXRrYwogSfAdFUt8NqvbLZ6aML2SOWpSb92sGMhM
Zxmxh9Rrt61CSaPJRdD5hiGLdug6Km601ZnGihYMX5bnPb9kaOV8taZJ+OZD+XvXPQxtGlp+uSLP
q8m7P1SRXuijnYxoi4BGTHuol4O/Bx3p80qJf/vy+eb+1/Xtj/vvt19/3f1kZgBRvsRjmXWRrkxa
1TjoUK74lRxn5A7MgDQCq+h/YWfkKezwrP3bsLKxM/IU9hcdhnrkrwQAAA==
EOF
true \
  && <<EOF base64 -d|gzip -d|$SUDO tee /etc/redis/redis-eagle.conf >/dev/null &&
H4sIAEozM2cAA31TTW/bMAy961cI6VlJnC5ZdyywYCiwQ7EedixoiU6E6GuS7Mwp+t9HKWmWNVht
wBD5+KH3SN9wdsMjKp1Ewjhg5NK7Tm84KAgZFe985I/w8HTP17AxOKVw1mqn+HxaXxZ8zHx1+/kL
C9FnlJQkrFfInWdZBtGC3Bm/4cumYVlb9H3m84rsEAMYPSDZCtB6pw/IR0wsaNVpg3wWezert5th
6X48i3qeUhCjwgYHNNQsa4nFPiYOEGdknJIv08hL3TK0kDDxZsXA7GEk+lu/FwT6cvGEWRAdKbLO
5nSnsyky2mAgI5+8VMcrfzE6ZXQClIpkHaWsMrxOWMo+iH3UGZPwTrSbBAMKjJGkLZWjaqW3IWJK
2ruza4tyl3pbbdUWWg4sctXbMCW8xAiFRqTRSVHgVG6udDyx1+2ldAxCQKe8M2OteDTPVSd/4Sn4
bnLCqdp7mFxvaFdac9I/jgklc15c+AvViJV2uRf0mWDfvflEwCjRZdggb+bXsNVOpLIPzcq2LBm/
p9mU+YhyJnHzFhxl0nNGLfwWxIc3iztWFqIbacfGFECS3AM1S3wyqbMtkZpsOpI7atJu2SwYyEzr
GHELaavdpgoljaYQQWsb+izavuuoudFWZ6IVLRg+L+9HccnQwPliSUz46lP5fBge+jb1Lb9dUOTd
MXp7qCJd6KOdjGiLgEYc51D3Bn/1OtJvlRL/sf768PS8vv/2ff38+JOZHkT5/05NlkW4wrNqcdCh
bPA/YlyBA5geiQCr1v/SrsBz2uFN+fdpZV5X4DntDwrUzz+jBAAA
EOF
true \
  && `# Configure logging ` \
  && <<EOF base64 -d|gzip -d|$SUDO tee /etc/logrotate.d/redis-houston >/dev/null &&
H4sIAMo2M2cAA0WMSwqAMBBD956ia0G78ULFjrX0M6UzKkW8u4IyZhHIS4jeTdURna5gPb0+rLgR
Y+7Hp1Bnpz4dACE2ickT+ewwCKnIhkFNAmZMpQKRgIzsF0iF/xsL0TQZXt0NK02chpIAAAA=
EOF
true \
  && <<EOF base64 -d|gzip -d|$SUDO tee /etc/logrotate.d/redis-eagle >/dev/null &&
H4sIAOo2M2cAA0XMwQqAIBAE0Ltf4TkoL/2Q5CSSuuJKIdG/FxTbHgbmMazZbTWRvKlwgd8cYX3E
MD2sT6W/O4AtdqkpMIfsaROp1GyDngUWSqWCWSBTCytSaf8bh2i7DC91A0WammaQAAAA
EOF
true \
  && `# Register as new services ` \
  && <<EOF_uQAAAOgdAABpQAAA base64 -d|gzip -d|$SUDO tee /etc/init.d/redis-houston >/dev/null &&
H4sIAJgxM2cAA5VTXW/aMBR9jn/FbYimdZIb6NZVomISHbSNVCgC+jRNKCROsRrizHa6VoX/vmsn
ZKRim/aS2L5f55x7b+sI/CXPfLUirVYLLofXwRiCcTDHz9UdacFEiiceM9V1HMliruhKFEqLDE1T
9qPg+EhnOpS663jqRaXiATzJ1kKzRaKaTiL/g88Mc6Z1GsdLRRSmb0wmuGEZsCQsUr2LOoWP8AnO
GgYb04YOfC4zSU0HTEWS55qLrNskBBSx4h0Gl5AICZMwmPXhpmbbiKxCFZNPTP4jEmUdjgd7ohIy
6c9ven6hpG8J+Qpb0N2722v5WFt+++CBDPrD0d24t7v7+3gq46I/vZ71fKaj0uo36J5EIkvIuD8a
9pp9HQxnX988ken9eBBMe74sqkr+zjQJBlfB7bDnlS5vauQ8JkQzpYE+g1fCgs0G2DPX0CaEJ/AN
qAQLMi775nsGFHwnesUy4pwcMJKEE4KGlC/9VC19nnFNkyKLTHMUIYphQVald733PAZaHLtw1AO3
7dapcQ4XScjTQrLFWj2AO0LUsGSANCFUIIXQJy5xLNqOLRqFimHGjgvYAwBlZu8YPaKVAJqBa4eR
ZzjfRsYuYPT6MeY4IjlUEhFHiyJagVdJRxwM/pmBVa5rvzvXhs9axHB+dlanIU6pHlb17m+DUTA3
zJySmlOkfI2o0VoZjexaFow4hoeJteAp9imncYjbiBtA7Rv+cWeNhlQ8ZiJGarRYh+oR2u1zPGNX
E56yGh0+RasCRd6nQCl7ZlHddEp3RzuWNU6rnGu7aqVOFatfTW9Y7FrEzsWF1VvkTblFnjfk/gsz
keNPMi1fzJYyXBR/PpyO/M4hvgc47vP5f/xyDTTZa6hKGctxqgwxZCaZBb1BZBFDlKkIY2Tqvba3
lnV9RKddDF50odCrPCxEssiliOysvVaFtngsIZuTgbndhX/YKeneq/CBdctFM7t0EldL+FqCMgA2
hxBuyspbF768O60XxeRnKowIqfb8F5G7/VplBgAA
EOF_uQAAAOgdAABpQAAA
true \
  && <<EOF_FgsAAD8WAACUVQAA base64 -d|gzip -d|$SUDO tee /etc/init.d/redis-eagle >/dev/null &&
H4sIAAAAAAAAA5VTbW/TMBD+HP+KI40QIHlpgTGpqEgdLRBpLVPbfUKoypLLai2Ng+3ApnX/nbOT
hgYVBF+Ss+/Fz/PcXe8JhNeiCPWG9Xo9OJ9+jOYQzaMVfT58Zj24VPK7SFEPPU9hKjTH+CZHcizw
WyXoii9NrMzQC/S9zuUNBAq30uA6090gWf4hZrmRVd6W8YJcJnH+m8smdzwTzOIqN/usl/AKXsNp
x+Fy+jCAN3UlZfgEdaJEaYQshod0gBNSOsHkHDKp4DKOlmOYNkw7Wf+cRmpO55MDLRm7HK8+jcJK
q9AxCTUpPzw4u2N92Xp+xZDBJuPp7PN8tD+HNRiN6juqxrkeLz4uRyGapPaGB4BPEllkbD6eTUeH
zZxMl+87F2xxNZ9Ei1GoquaNsHZcRpMP0cV0FNQBndqlSBkzqA3wOwhqMLDbAd4JA33GRAZfgCtw
0NK6TWFgwcBXZjZYMO/kiJNlgjFy5OI6zPV1KApheFYVie2HZkwjPYhNeT94JlLg1XMfnozA7/tt
aRq7dRaLvFK43uob8GcVIb1GIIoQa1BSmhOfeQ7twD2axBqp4sAHUh5A21F7ThHJRgIvwHezJwoa
ZyvgECh7e5sKBbyERiDmGVklGwga4ZhHyT8KcLoN3Xcf2onZyhTOTk/bMsyr1aNXg6uLaBatLDOv
puZVudgSavI2Tiu7URUyz/KwuQ4817QUPI1p+Qrg3N3Rn1bUasjlbSFTosarbaxvod8/I5u6mgka
9T06uko2FYl8SIFzvMOkbTrne9MNY4vTKee7rjqpc43tre0Npr5D7L196/SWZVduWZYduf/CTJb0
U2jUvd1MpPUIV9PFLBwc43uE4yGf/8evtsCzg4bqHLGkqbLEiJlCB3pHyBIklLmMU2IaPPQfHevW
pKB9Dh1MpSmqNtYyW5dKJm7WHpqHHsmsIVvLwnzcp7/YK+lf6fgGh/Wi2V06SZslfKhBWQC7Ywh3
9cuPPrx7+rJdFFsfdZww1uz5T5ei0QZSBgAA
EOF_FgsAAD8WAACUVQAA
true \
  && `# Tune file permissions, inject some variables into config files ` \
  && $SUDO chmod 755 /etc/init.d/redis-houston /etc/init.d/redis-eagle \
  && $SUDO mkdir /var/lib/redis/houston /var/lib/redis/eagle \
  && $SUDO chown redis:redis /var/lib/redis/houston /var/lib/redis/eagle \
  && $SUDO sed -i -E 's,REDIS_HOUSTON_PW,'"${REDIS_HOUSTON_PW?}"',g' /etc/redis/redis-houston.conf \
  && $SUDO sed -i -E 's,REDIS_EAGLE_PW,'"${REDIS_EAGLE_PW?}"',g' /etc/redis/redis-eagle.conf \
  && `# Enable the two new redis servers ` \
  && $SUDO update-rc.d redis-houston defaults \
  && $SUDO update-rc.d redis-eagle defaults \
  && `# Add 'user' to 'adm' group to allow access to logs ` \
  && $SUDO sed -i -E 's/^(adm:x:[^:]*:.+)$/\1'",$USER"'/' /etc/group \
  && $SUDO sed -i -E 's,^(adm:x:[^:]*:)$,\1'"$USER"',' /etc/group \
  && `# Cleanup for smaller VM images ` \
  && $SUDO apt clean \
  && printf 'DONE :)\n' \



## PostInstall at VM host

  && VM= \
  && NOW=$(date -u +%Y%m%d-%H%M%S) \
  && DSTTAR="qemu-paisa-redis-${NOW:?}.tar" \
  && DSTTXZ="${DSTTAR%.*}.txz" \
  && DSTMD5="${DSTTAR%.*}.md5" \
  && HDA=hda.qcow2 \
  && TMP1=sparsed.qcow2 \
  && TMP2=snap.qcow2 \
  && ssh "${VM:?}" 'sudo rm /tmp/* /root/.bash_history .bash_history' \
  && ssh "${VM:?}" 'sudo poweroff && while true;do sleep 1;done' \
  && sleep 10 \
  && qemu-img convert -O qcow2 -S 1M "${HDA:?}" "${TMP1:?}" \
  && mv "${HDA:?}" "${TMP2:?}" \
  && mv "${TMP1:?}" "${HDA:?}" \
  && tar --owner=0 --group=0 -cf "${DSTTAR:?}" README "${HDA:?}" MD5SUM \
  && md5sum -b "${DSTTAR:?}" >> "${DSTMD5:?}" \
  && < "${DSTTAR:?}" xz -vv --lzma2=preset=9,nice=273,dict=1G > "${DSTTXZ:?}" \
  && md5sum -b "${DSTTXZ:?}" >> "${DSTMD5:?}" \


